<!-- shoe-details.ejs -->
<div id="shoeDetails" data-shoe-id="<%= shoe._id %>">
    <div class="shoe-container">
        <div class="shoe-images">
            <img src="<%= shoe.image %>" alt="<%= shoe.title %>">
        </div>
        <div class="shoe-info">
            <h1><%= shoe.title %></h1>
            <p class="category"><%= shoe.category %></p>
            <p class="price">$<%= shoe.price %></p>
            <p class="description"><%= shoe.description %></p>
            
            <div class="size-selector">
                <label for="shoe-size">Select Size:</label>
                <select id="shoe-size" name="shoe-size">
                    <option value="">Select a size</option>
                    <% [36, 37, 38, 39, 40, 41, 42, 43, 44, 45].forEach(size => { %>
                        <option value="<%= size %>"><%= size %></option>
                    <% }); %>
                </select>
            </div>
            
            <button class="add-to-cart">Add to Cart</button>
            <button class="buy-now">Buy Now</button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <p id="successMessage"></p>
    </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <p id="errorMessage"></p>
    </div>
</div>

<script>
    document.querySelector('.buy-now').addEventListener('click', function() {
        const shoeId = document.getElementById('shoeDetails').dataset.shoeId;
        const title = document.querySelector('h1').innerText;
        const price = parseFloat(document.querySelector('.price').innerText.replace('$', ''));
        const description = document.querySelector('.description').innerText;
        const size = document.querySelector('#shoe-size').value;

        if (!size) {
            showErrorModal('Please select a size');
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
            showErrorModal('Please log in to make a purchase');
            return;
        }

        const purchaseData = {
            shoeId,
            title,
            price,
            description,
            size
        };

        fetch('/api/purchase', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(purchaseData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === "Purchase successful") {
                showSuccessModal('Purchase successful!');
            } else {
                throw new Error(data.message || 'Error making purchase. Please try again.');
            }
        })
        .catch(error => {
            showErrorModal('Error: ' + error.message);
        });
    });

    function showSuccessModal(message) {
        const modal = document.getElementById('successModal');
        document.getElementById('successMessage').innerText = message;
        modal.style.display = 'block';
    }

    function showErrorModal(message) {
        const modal = document.getElementById('errorModal');
        document.getElementById('errorMessage').innerText = message;
        modal.style.display = 'block';
    }

    document.querySelectorAll('.close-button').forEach(button => {
        button.addEventListener('click', function() {
            button.parentElement.parentElement.style.display = 'none';
        });
    });

    window.addEventListener('click', function(event) {
        const successModal = document.getElementById('successModal');
        const errorModal = document.getElementById('errorModal');
        if (event.target === successModal || event.target === errorModal) {
            successModal.style.display = 'none';
            errorModal.style.display = 'none';
        }
    });

    document.querySelector('.add-to-cart').addEventListener('click', function() {
        const shoeId = document.getElementById('shoeDetails').dataset.shoeId;
        const title = document.querySelector('h1').innerText;
        const price = parseFloat(document.querySelector('.price').innerText.replace('$', ''));
        const description = document.querySelector('.description').innerText;
        const size = document.querySelector('#shoe-size').value;
        const quantity = 1; // You can add a quantity selector if needed

        if (!size) {
            showErrorModal('Please select a size');
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
            showErrorModal('Please log in to add items to the cart');
            return;
        }

        fetch('/api/users/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                shoeId,
                title,
                price,
                description,
                size,
                quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === "Item added to cart") {
                showSuccessModal('Item added to cart');
            } else {
                showErrorModal('Failed to add item to cart');
            }
        })
        .catch(error => {
            showErrorModal('Error: ' + error.message);
        });
    });
</script>
